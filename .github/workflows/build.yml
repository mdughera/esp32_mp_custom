name: Build MicroPython Firmware with Frozen Modules

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Select the board to build firmware for'
        required: true
        default: 'M5STACK_ATOMS3_LITE'
        type: choice
        options:
          - M5STACK_ATOMS3_LITE
          - ESP32_GENERIC_S3
          - TTGO_T7
          - LILYGO_TTGO_S3

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BOARD: ${{ github.event.inputs.board }}  # environment variable for selected board

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Python 3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3️⃣ Install mpbuild, esptool, and mpy-cross for MicroPython 1.27
      - name: Install dependencies
        run: |
          python --version
          pip install --upgrade pip
          pip install typing_extensions mpbuild esptool mpy-cross==1.27.0.post2

      # 4️⃣ Clone MicroPython 1.27 source
      - name: Clone MicroPython v1.27.0
        run: |
          git clone https://github.com/micropython/micropython.git
          cd micropython
          git checkout v1.27.0
          echo "Checked out MicroPython v1.27.0"

      # 4.5️⃣ Copy Python modules for freezing
      - name: Copy modules for freezing
        run: |
          MICROPY_DIR=$(pwd)/micropython
          MODULES_DIR="$MICROPY_DIR/ports/esp32/modules"
          mkdir -p "$MODULES_DIR"

          if [ -z "$(ls $GITHUB_WORKSPACE/modules/*.py 2>/dev/null)" ]; then
              echo "Error: No Python modules found in $GITHUB_WORKSPACE/modules/"
              exit 1
          fi

          cp $GITHUB_WORKSPACE/modules/*.py "$MODULES_DIR/"

      # 4.6️⃣ Precompile .py modules to .mpy (syntax check)
      - name: Precompile modules to .mpy (syntax check)
        run: |
          for f in $GITHUB_WORKSPACE/modules/*.py; do
              echo "Precompiling $(basename $f)"
              mpy-cross "$f" || { echo "Syntax error in $(basename $f)"; exit 1; }
          done

      # 5️⃣ Build firmware using selected board
      - name: Build firmware
        run: |
          cd micropython
          mpbuild build $BOARD

      # 6️⃣ Merge binaries into single .bin
      - name: Merge firmware into single .bin
        run: |
          export BOARD=$BOARD
          cd micropython/ports/esp32/build-$BOARD
          python -m esptool --chip esp32s3 merge-bin \
            -o ${BOARD}.bin \
            --flash-mode dio \
            --flash-size 8MB \
            --flash-freq 80m \
            0x0 bootloader/bootloader.bin \
            0x8000 partition_table/partition-table.bin \
            0x10000 micropython.bin

      # 7️⃣ Upload the merged firmware as a GitHub artifact
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4

        with:
          name: ${{ env.BOARD }} firmware
          path: micropython/ports/esp32/build-${{ env.BOARD }}/${{ env.BOARD }}.bin

