name: Build MicroPython Firmware for Stamp-S3 with Frozen .mpy Modules

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Python 3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3️⃣ Install mpbuild and esptool
      - name: Install mpbuild and esptool
        run: |
          python --version
          pip install --upgrade pip
          pip install typing_extensions mpbuild esptool

      # 4️⃣ Clone latest MicroPython release
      - name: Clone latest MicroPython release
        run: |
          git clone https://github.com/micropython/micropython.git
          cd micropython
          latest_tag=$(git tag --sort=-creatordate | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' | head -n1)
          git checkout "$latest_tag"
          echo "Checked out MicroPython $latest_tag"

      # 4.5️⃣ Build mpy-cross and precompile modules
      - name: Build mpy-cross and freeze modules
        run: |
          MICROPY_DIR=$(pwd)/micropython

          # Build mpy-cross
          cd "$MICROPY_DIR/mpy-cross"
          make -j$(nproc)

          # Detect mpy-cross binary
          if [ -f ./mpy-cross ]; then
              MPY_CROSS=$(pwd)/mpy-cross
          elif [ -f ./build/mpy-cross ]; then
              MPY_CROSS=$(pwd)/build/mpy-cross
          else
              echo "Error: mpy-cross binary not found!"
              exit 1
          fi
          echo "Using mpy-cross: $MPY_CROSS"

          # Prepare modules folder
          MODULES_DIR="$MICROPY_DIR/ports/esp32/modules"
          mkdir -p "$MODULES_DIR"

          # Compile all modules to .mpy and copy to ports/esp32/modules
          for f in ../../modules/*.py; do
              echo "Compiling $f to .mpy"
              "$MPY_CROSS" "$f"
              cp "${f%.py}.mpy" "$MODULES_DIR/"
          done

          # ✅ No freeze.py needed; mpbuild will pick up .mpy files automatically

      # 5️⃣ Build ESP32_GENERIC_S3 firmware
      - name: Build ESP32_GENERIC_S3 firmware
        run: |
          cd micropython
          mpbuild build ESP32_GENERIC_S3

      # 6️⃣ Merge binaries into single .bin (8MB flash for Stamp-S3)
      - name: Merge firmware into single ESP32_GENERIC_S3.bin
        run: |
          cd micropython/ports/esp32/build-ESP32_GENERIC_S3
          python -m esptool --chip esp32s3 merge_bin \
            -o ESP32_GENERIC_S3.bin \
            --flash_mode dio \
            --flash_size 8MB \
            --flash_freq 80m \
            0x0 bootloader/bootloader.bin \
            0x8000 partition_table/partition-table.bin \
            0x10000 micropython.bin

      # 7️⃣ Upload the merged firmware as a GitHub artifact
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stamp-S3_firmware
          path: micropython/ports/esp32/build-ESP32_GENERIC_S3/ESP32_GENERIC_S3.bin
