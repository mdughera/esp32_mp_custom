name: Build MicroPython Firmware for Stamp-S3 with Frozen Modules

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Python 3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3️⃣ Install mpbuild, esptool, and mpy-cross for MicroPython 1.27
      - name: Install dependencies
        run: |
          python --version
          pip install --upgrade pip
          pip install typing_extensions mpbuild esptool mpy-cross==1.27.0.post2

      # 4️⃣ Clone MicroPython 1.27 source
      - name: Clone MicroPython v1.27.0
        run: |
          git clone https://github.com/micropython/micropython.git
          cd micropython
          git checkout v1.27.0
          echo "Checked out MicroPython v1.27.0"

      # 4.5️⃣ Copy Python modules for freezing
      - name: Copy modules for freezing
        run: |
          MICROPY_DIR=$(pwd)/micropython
          MODULES_DIR="$MICROPY_DIR/ports/esp32/modules"
          mkdir -p "$MODULES_DIR"

          # Ensure modules exist
          if [ -z "$(ls $GITHUB_WORKSPACE/modules/*.py 2>/dev/null)" ]; then
              echo "Error: No Python modules found in $GITHUB_WORKSPACE/modules/"
              exit 1
          fi

          # Copy your modules for mpbuild to freeze
          cp $GITHUB_WORKSPACE/modules/*.py "$MODULES_DIR/"

      # 4.6️⃣ Precompile .py modules to .mpy for syntax check using PyPI mpy-cross
      - name: Precompile modules to .mpy (syntax check)
        run: |
          # Precompile only your repo modules in /modules
          for f in $GITHUB_WORKSPACE/modules/*.py; do
              echo "Precompiling $(basename $f)"
              mpy-cross "$f" || { echo "Syntax error in $(basename $f)"; exit 1; }
          done

      # 5️⃣ Build ESP32_GENERIC_S3 firmware (mpbuild handles freezing)
      - name: Build M5STACK_ATOMS3_LITE firmware
        run: |
          cd micropython
          mpbuild build M5STACK_ATOMS3_LITE

      # 6️⃣ Merge binaries into single .bin (8MB flash for Stamp-S3)
      - name: Merge firmware into single M5STACK_ATOMS3_LITE.bin
        run: |
          cd micropython/ports/esp32/build-M5STACK_ATOMS3_LITE
          python -m esptool --chip esp32s3 merge_bin \
            -o M5STACK_ATOMS3_LITE.bin \
            --flash_mode dio \
            --flash_size 8MB \
            --flash_freq 80m \
            0x0 bootloader/bootloader.bin \
            0x8000 partition_table/partition-table.bin \
            0x10000 micropython.bin

      # 7️⃣ Upload the merged firmware as a GitHub artifact
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: M5STACK_ATOMS3_LITE firmware
          path: micropython/ports/esp32/build-M5STACK_ATOMS3_LITE/M5STACK_ATOMS3_LITE.bin
